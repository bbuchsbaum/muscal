---
phase: 01-foundation-fix
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - R/mfa.R
  - tests/testthat/test-mfa.R
autonomous: true

must_haves:
  truths:
    - "MFA examples run without error (or are properly wrapped)"
    - "The 1 failing test now passes"
    - "All 150 tests pass with devtools::test()"
  artifacts:
    - path: "R/mfa.R"
      provides: "MFA with working examples"
      contains: "dontrun|donttest|if.*requireNamespace"
  key_links:
    - from: "R/mfa.R examples"
      to: "genpca package"
      via: "conditional execution or dontrun wrapper"
      pattern: "dontrun|donttest|requireNamespace.*genpca"
---

<objective>
Fix failing examples and the failing test to achieve clean test suite.

Purpose: All tests pass and examples either work or are properly wrapped to avoid R CMD check errors.
Output: 150/150 tests passing, examples wrapped appropriately.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@R/mfa.R
@tests/testthat/test-mfa.R
@man/mfa.Rd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify and fix the failing test</name>
  <files>tests/testthat/*.R</files>
  <action>
1. Run `devtools::test()` or `testthat::test_dir("tests/testthat")` to identify which test is failing.
2. Examine the failing test to understand why it fails.
3. Fix the test or the underlying code issue.

The STATE.md says 149/150 tests pass, so there's exactly 1 failing test. Common causes:
- API change in a dependency (multivarious, genpca, etc.)
- Floating point comparison without tolerance
- Missing test fixtures or setup
- Deprecated function usage

After identifying the test, determine if:
a) The test expectation is wrong (fix the test)
b) The code has a bug (fix the code)
c) A dependency changed (update code to match new API)
  </action>
  <verify>
Run `Rscript -e "devtools::test()"` - all tests should pass (0 failures).
  </verify>
  <done>
All 150 tests pass. The previously failing test is fixed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix or wrap MFA examples for genpca dependency</name>
  <files>R/mfa.R</files>
  <action>
The MFA examples in R/mfa.R (lines 76-126) use `mfa()` which internally calls `genpca::genpca()`.
If genpca is not installed, the examples will fail during R CMD check.

Options (in order of preference):
1. **Conditional execution**: Wrap examples in `if (requireNamespace("genpca", quietly = TRUE)) { ... }`
2. **donttest**: Use `\donttest{ }` - examples skip during R CMD check but can be run manually
3. **dontrun**: Use `\dontrun{ }` - examples never run automatically (last resort)

Recommended approach: Use `\donttest{}` for the full examples since genpca is a Suggested dependency.

In roxygen comments, change:
```r
#' @examples
#' X <- replicate(5, ...)
#' res <- mfa(X, ncomp=3)
```
To:
```r
#' @examples
#' \donttest{
#' X <- replicate(5, ...)
#' res <- mfa(X, ncomp=3)
#' }
```

Apply to both `mfa.list` and `mfa.multiblock` example sections.

After editing, run `devtools::document()` to regenerate man/mfa.Rd.
  </action>
  <verify>
Run `R CMD check --as-cran . 2>&1 | grep -i "example\|mfa"` - should show no example errors.
Or: `Rscript -e "devtools::run_examples()"` should complete without errors.
  </verify>
  <done>
MFA examples are wrapped in donttest{} blocks. R CMD check does not fail on examples.
Examples can still be run manually when genpca is installed.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `devtools::test()` reports 0 failures (all 150 tests pass)
2. `R CMD check --as-cran .` does not fail on examples
3. Examples are accessible for manual testing when dependencies available
</verification>

<success_criteria>
- All 150 tests pass (0 failures)
- MFA examples don't cause R CMD check failures
- Examples remain runnable manually when genpca is installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fix/01-03-SUMMARY.md`
</output>
