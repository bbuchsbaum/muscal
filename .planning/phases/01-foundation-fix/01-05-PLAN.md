---
phase: 01-foundation-fix
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - R/bamfa.R
  - DESCRIPTION
  - NAMESPACE
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "R CMD check reports 0 warnings (no import conflicts)"
    - "R CMD check NOTE about undefined global functions resolved"
  artifacts:
    - path: "R/bamfa.R"
      provides: "Roxygen imports without RcppEigen"
      contains: "@import RcppArmadillo"
      not_contains: "@import RcppEigen"
    - path: "DESCRIPTION"
      provides: "RcppEigen removed from Imports but retained in LinkingTo"
      not_contains_in_section:
        section: "Imports"
        value: "RcppEigen"
      contains: "LinkingTo: Rcpp, RcppArmadillo, RcppEigen"
    - path: "NAMESPACE"
      provides: "Proper imports for coef, shape, multidesign"
      contains: "importFrom(stats,coef)"
  key_links:
    - from: "R/bada.R"
      to: "stats::coef"
      via: "NAMESPACE importFrom"
      pattern: "importFrom\\(stats,coef\\)"
    - from: "R/bada.R"
      to: "multivarious::shape"
      via: "NAMESPACE importFrom"
      pattern: "importFrom\\(multivarious,shape\\)"
    - from: "R/bada.R"
      to: "multidesign::multidesign"
      via: "NAMESPACE importFrom"
      pattern: "importFrom\\(multidesign,multidesign\\)"
---

<objective>
Close gaps from Phase 1 verification: resolve RcppArmadillo/RcppEigen import conflict and add missing NAMESPACE imports.

Purpose: Achieve true "0 warnings" for R CMD check by removing unused RcppEigen dependency and fixing undefined global function NOTEs.
Output: Clean R CMD check with 0 errors, 0 warnings, minimal NOTEs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-fix/01-VERIFICATION.md

# Key files
@DESCRIPTION
@NAMESPACE
@R/bamfa.R
@R/bada.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove RcppEigen dependency from R imports</name>
  <files>R/bamfa.R, DESCRIPTION</files>
  <action>
1. In R/bamfa.R line 4: Remove `@import RcppEigen` entirely (the code only uses RcppArmadillo via the C++ ridge_solve function, not RcppEigen directly)

2. In DESCRIPTION:
   - Remove `RcppEigen,` from Imports section (line 32)
   - KEEP RcppEigen in LinkingTo (line 47) - it is required for C++ compilation as RcppExports.cpp includes RcppEigen headers

The import conflict warning "replacing previous import 'RcppArmadillo::fastLmPure' by 'RcppEigen::fastLmPure'" occurs because both packages are imported at the R level. By removing the R-level import of RcppEigen, we eliminate the conflict while keeping the C++ linkage.
  </action>
  <verify>
- `grep -n "RcppEigen" R/bamfa.R` returns no matches
- `grep "RcppEigen" DESCRIPTION` only shows LinkingTo line (line 47)
- `devtools::document()` regenerates NAMESPACE without import(RcppEigen)
  </verify>
  <done>RcppEigen removed from R imports (DESCRIPTION Imports + roxygen), retained only in LinkingTo for C++ compilation</done>
</task>

<task type="auto">
  <name>Task 2: Add missing NAMESPACE imports</name>
  <files>R/bada.R</files>
  <action>
Add roxygen2 importFrom directives to R/bada.R to resolve the "undefined global functions" NOTE:

1. `coef` - used in line 366: `reprocess(x, new_data, block = block) %*% coef(x)`
   Add: `#' @importFrom stats coef`

2. `shape` - used in lines 307, 317: `chk::chk_equal(ncol(new_data), shape(x)[1])`
   Add: `#' @importFrom multivarious shape`

3. `multidesign` - used in lines 100, 181: `multidesign(Xout, sdat[[i]]$design)`
   This is ALREADY imported in NAMESPACE line 87 via multidesign package, but the function is used without qualification. The NOTE may be spurious or the import needs to be in the file that uses it.
   Add: `#' @importFrom multidesign multidesign` to R/bada.R

Add these imports to the roxygen block at the top of R/bada.R (near the existing @importFrom directives around line 147).
  </action>
  <verify>
- `devtools::document()` runs without error
- `grep "importFrom(stats,coef)" NAMESPACE` returns a match
- `grep "importFrom(multivarious,shape)" NAMESPACE` returns a match
- `grep "importFrom(multidesign,multidesign)" NAMESPACE` returns a match
  </verify>
  <done>All undefined global functions have explicit imports in NAMESPACE</done>
</task>

<task type="checkpoint:verify">
  <name>Task 3: Verify R CMD check clean</name>
  <what-built>RcppEigen import conflict resolved, missing NAMESPACE imports added</what-built>
  <how-to-verify>
1. Run `devtools::document()` to regenerate NAMESPACE
2. Run `devtools::check()` or `R CMD build . && R CMD check muscal_*.tar.gz`
3. Verify:
   - 0 errors
   - 0 warnings (specifically: no "replacing previous import" warning)
   - NOTEs should not include "undefined global functions" for coef, shape, multidesign

Note: Some NOTEs are acceptable (e.g., "checking CRAN incoming feasibility" notes about new submission). The compiler pragma warning about '-Wfixed-enum-extension' is environment-specific (Homebrew clang) and not addressable at package level.
  </how-to-verify>
  <resume-signal>Type "verified" if R CMD check shows 0 errors and 0 warnings, or describe issues found</resume-signal>
  <done>R CMD check passes with 0 errors, 0 warnings</done>
</task>

</tasks>

<verification>
After all tasks:
1. `devtools::test()` still passes (150/150 tests)
2. `R CMD check` reports 0 errors, 0 warnings
3. NAMESPACE has proper imports for coef, shape, multidesign
4. No RcppEigen import conflict warning
</verification>

<success_criteria>
- R CMD check: 0 errors, 0 warnings
- All 150 tests still pass
- NAMESPACE includes: importFrom(stats,coef), importFrom(multivarious,shape), importFrom(multidesign,multidesign)
- No "replacing previous import" warning
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fix/01-05-SUMMARY.md`
</output>
