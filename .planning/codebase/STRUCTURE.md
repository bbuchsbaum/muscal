# Codebase Structure

**Analysis Date:** 2026-01-22

## Directory Layout

```
muscal/
├── R/                          # Main R source code (analysis functions)
│   ├── all_generic.R           # S3 generic function definitions
│   ├── mfa.R                   # Multiple Factor Analysis implementation
│   ├── bamfa.R                 # Barycentric MFA implementation
│   ├── penalized_mfa.R         # Penalized MFA implementation
│   ├── penalized_mfa_clusterwise.R # Clusterwise penalized MFA
│   ├── bada.R                  # Barycentric Discriminant Analysis
│   ├── covstatis.R             # STATIS for covariance matrices
│   ├── utils.R                 # General utilities and preprocessing helpers
│   ├── components_utils.R      # Component estimation and reliability analysis
│   ├── synthdat.R              # Synthetic data generation
│   ├── RcppExports.R           # Auto-generated Rcpp bindings
│   └── tibble-imports.R        # Tibble re-exports (empty bridge)
│
├── src/                        # C++ source code for performance-critical functions
│   ├── ridge_solve.cpp         # Ridge regression solver in C++
│   └── RcppExports.cpp         # Rcpp integration code
│
├── tests/                      # Test suite
│   └── testthat/               # Testthat-based unit tests
│       ├── test-mfa.R
│       ├── test-bamfa.R
│       ├── test-bamfa-recon.R
│       ├── test-penalized-mfa.R
│       ├── test-penalized-mfa-opts.R
│       ├── test-penalized-mfa-clusterwise.R
│       ├── test-bada-multidesign.R
│       ├── test-covstatis.R
│       ├── test-synthdat.R
│       ├── test-utils-misc.R
│       ├── test-utils-extra.R
│       ├── test-internal-utils.R
│       ├── test-summary-utils.R
│       ├── test-project-covariate.R
│       └── _snaps/             # Snapshot tests for output verification
│
├── man/                        # Generated documentation files (.Rd files)
│
├── dev/                        # Development resources
│   ├── design.md               # Architecture and design principles
│   ├── todo.md                 # Development roadmap
│   └── musca.code-workspace    # VS Code workspace config
│
├── .planning/                  # GSD planning documents
│   └── codebase/               # Architecture analysis (this file's home)
│
├── DESCRIPTION                 # Package metadata (version, dependencies, etc.)
├── NAMESPACE                   # R package namespace (generated by roxygen2)
├── LICENSE                     # MIT license
└── check_todo.md               # TODO tracking document
```

## Directory Purposes

**R/ - Analysis Source Code:**
- Purpose: All user-facing analysis functions and internal helpers
- Contains: S3 generics, concrete methods, preprocessing, computation helpers
- Key files: `all_generic.R` (dispatch), analysis files (mfa.R, bamfa.R, etc.), utilities

**src/ - C++ Performance Kernel:**
- Purpose: High-performance numerical operations compiled to native code
- Contains: Ridge regression solver, Rcpp integration
- Key files: `ridge_solve.cpp` (critical linear algebra), `RcppExports.cpp` (bindings)

**tests/testthat/ - Unit Tests:**
- Purpose: Test suite ensuring correctness of all analysis functions
- Contains: Method-specific tests, utility tests, integration tests
- Key files: One test file per analysis method, plus utility test files
- Pattern: Tests follow format `test-<module>.R` where module is the function/feature tested

**man/ - Documentation:**
- Purpose: Roxygen2-generated .Rd files for R help system
- Contains: Generated documentation from roxygen comments in R/ files
- Generated by: `roxygen2::roxygenise()`
- Committed: Yes (documentation is versioned)

**dev/ - Development Resources:**
- Purpose: Non-deployed design documents and roadmaps
- Contains: `design.md` (architecture principles), `todo.md` (feature roadmap)
- Not committed to deployed builds

## Key File Locations

**Entry Points:**
- `R/all_generic.R`: Defines S3 generics (`mfa()`, `bamfa()`, `penalized_mfa()`, etc.)
- `R/mfa.R`: Implements `mfa.list()` and `mfa.multiblock()` concrete methods
- `R/bamfa.R`: Implements BaMFA methods for list, multiblock, multidesign
- `R/penalized_mfa.R`: Implements penalized MFA with Adam optimizer
- `R/bada.R`: Implements BaDA methods
- `R/covstatis.R`: Implements STATIS for covariance matrices

**Configuration:**
- `DESCRIPTION`: Package version, dependencies (imports/suggests), R version requirement
- `NAMESPACE`: Exports (functions users can call), imports (what the package uses)
- `dev/design.md`: Architectural principles and design guidelines

**Core Logic:**
- `R/mfa.R` (220 lines): MFA algorithm, normalization factor computation
- `R/penalized_mfa.R` (693 lines): Penalized MFA with alternating optimization and Adam updates
- `R/penalized_mfa_clusterwise.R` (1191 lines): Clusterwise penalized MFA with block-specific penalties
- `R/bamfa.R` (525 lines): BaMFA decomposition into global + block-specific subspaces
- `R/covstatis.R` (517 lines): STATIS analysis for covariance matrices
- `R/bada.R` (345 lines): Barycentric discriminant analysis
- `R/utils.R` (381 lines): Preprocessing, bootstrap summarization, utility functions
- `src/ridge_solve.cpp` (30 lines): Fast ridge regression via Rcpp

**Testing:**
- `tests/testthat/test-mfa.R`: MFA algorithm tests, normalization validation
- `tests/testthat/test-bamfa.R`: BaMFA method dispatch, structure validation
- `tests/testthat/test-penalized-mfa.R`: Penalized MFA convergence, penalty behavior
- `tests/testthat/test-covstatis.R`: STATIS computation, projection methods
- `tests/testthat/test-utils-misc.R`: Utility function tests
- `tests/testthat/test-synthdat.R`: Synthetic data generation validation

## Naming Conventions

**Files:**
- Analysis modules: lowercase with underscores, e.g., `penalized_mfa.R`, `components_utils.R`
- Test files: `test-<module>.R` (e.g., `test-mfa.R`, `test-penalized-mfa.R`)
- C++ files: lowercase with underscores, matching function name, e.g., `ridge_solve.cpp`

**Functions:**
- S3 generics: lowercase, no underscores (e.g., `mfa()`, `bamfa()`, `covstatis()`)
- S3 methods: `generic.class` format (e.g., `mfa.list()`, `bamfa.multiblock()`)
- Internal helpers: snake_case with `.` in method names, e.g., `prepare_block_preprocessors()`, `compute_sim_mat()`
- Private functions: prefixed with `.` for unexported helpers, e.g., `.extract_V_list()`, `.infer_n()`

**Variables:**
- Data blocks/matrices: UPPERCASE for user data, e.g., `X`, `X_p` (preprocessed)
- Loadings/components: `V`, `V_list`, `V_true` (ground truth)
- Scores: `s`, `U`, `F_true` (ground truth)
- Singular values: `sdev`, `d`
- Block indices: `block_indices`, `idx`
- Normalization factors: `alpha`
- Temporary/loop variables: lowercase, e.g., `i`, `j`, `mat`, `proclist`

**Types:**
- S3 classes: lowercase with underscores, e.g., `multiblock_projector`, `bamfa`
- Lists of data: `*_list` suffix, e.g., `data_list`, `V_list`, `blocks`
- Processed/prepared data: `*_p` suffix, e.g., `X_p`, `Xp`

## Where to Add New Code

**New Analysis Function:**
- Primary implementation: Create new file `R/<method_name>.R`
  - Define S3 generic in `R/all_generic.R` (add `<method_name> <- function(...) UseMethod("<method_name>")`)
  - Implement `<method_name>.list()`, `<method_name>.multiblock()`, etc. in new file
  - Follow pattern from `R/mfa.R` or `R/bamfa.R`
- Tests: Create `tests/testthat/test-<method_name>.R`
- Documentation: Use roxygen2 comments in the function file (starts with `#'`)

**New Utility Function:**
- If it's general-purpose: Add to `R/utils.R`
- If it's method-specific: Create as internal helper in the analysis method file
- If it's for components/loadings: Add to `R/components_utils.R`
- Make internal functions with `.` prefix and `@keywords internal` roxygen tag

**New C++ Accelerator:**
- Create file `src/<function_name>.cpp`
- Use `[[Rcpp::export]]` to expose to R
- Wrap exported function in R wrapper in appropriate `R/<module>.R` file
- Add to `NAMESPACE` via roxygen: `@useDynLib muscal`

**New Test:**
- Create in `tests/testthat/test-<module>.R` (one file per module/feature)
- Use standard testthat patterns: `test_that()`, `expect_*()` assertions
- Import package and dependencies in file header: `library(testthat)`, `library(muscal)`

**New Data Helper:**
- Synthetic data generation: Add to `R/synthdat.R`
- General preprocessing/transformation: Add to `R/utils.R`
- Export via `NAMESPACE` if user-facing, mark as `@noRd` if internal

## Special Directories

**man/ - Generated Documentation:**
- Purpose: R's native documentation system
- Generated: Yes, by `roxygen2::roxygenise()` from R/ files
- Committed: Yes (versioned with releases)
- Content: .Rd files (one per exported function), automatically generated from roxygen comments
- Do not edit directly: Edit roxygen comments in R/ files instead

**tests/testthat/_snaps/ - Snapshot Tests:**
- Purpose: Store expected output for snapshot-based testing
- Generated: Yes, by `testthat::expect_snapshot()` on first run
- Committed: Yes (to validate output stability)
- Content: Text/serialized output snapshots for verification
- Update: Run tests with `UPDATE_SNAPSHOTS=TRUE` to regenerate when output intentionally changes

**.planning/codebase/ - GSD Architecture Documents:**
- Purpose: Machine-readable architecture for code generation
- Generated: No (created by analysis agents)
- Committed: Yes (serves as reference for future operations)
- Content: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md

**src/ - Build Artifacts:**
- Generated files: `.o` object files, `.so` shared library (compiled C++)
- Committed: No (always rebuilt from .cpp sources)
- Rebuild: `R CMD build` or `devtools::load_all()` automatically compiles

